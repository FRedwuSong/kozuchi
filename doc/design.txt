2006/5/25

がんばって作ろうぜ。

でもなにがテーマだか忘れたよ。

確か貸し借りだよな。

登録はできるようになったけど、削除や変更はできないべ。

そうだ、だから、無駄に変更しないようにしたいのよ。

よし。できた。

次は、クレジットカードの関係も、deal_link で表すようにしたい。
これによってソースが整理できるはず。

のまえに、これでフレンドリンクってうまくいくんだっけ？

フレンドリンクは、一度できたら、
　・account_entry が削除されたら
　　　対応する取引が確定前なら対応する取引を削除するべき
　　　対応する取引が確定済ならその取引との関係をなくすべき
　・account_entry が変更されたら
　　　対応する取引が確定前なら対応する取引の金額も変更するべき
　　　対応する取引が確定済ならその取引との関係をなくしてから新しい対応取引を作るべき

そうそう、これですよ。

テストは

・新規でちゃんとフレンドリンクがはられること

（相手が未確定のとき）
・変更で金額、サマリー、日にちがかわること
・削除で相手も消えること

（相手が確定のとき）
・変更で関係がきれて、べつのができること
・削除で関係がきれるだけ

一度目のテストは通るようになった。もう一度ひととおりテストして、ＯＫなら先へすすもう。
先とは・・・請求ルールも同じようにやること、かな。

これで deal が減り account_entry が増えるけど、作り直しがへるはずだ。

リファクタリング 2006/05/20

気になる点
・ account 同士のフレンド関係
　ベストではないきがするけれど　とりあえず新しい方式に統一する

・ deal_link の導入
　deal_link テーブルを作り、account_entry に friend_link_id として参照させる
 friend_deal テーブルを削除する
 
 まず新方式でデータが作れるようになってから旧方式の痕跡を消す
→作れるようにはなった。after_find の問題はあるが、途中状態を許すことにして、account_entry をセーブ後に作る方式で
いいとおもう。だってaccount_entry が　deal_id をもつ以上、そのほうが正しい順番だし。

旧方式を消す前に、旧方式ですでに入っているデータをどう移行すればいいか考えよう。

・・・あ、はいってないな、フレンド連動はまだ。

だから気にせず消して平気だ。精算の方式を変える場合にデータ移行が必要なんだな。あっちも変えたくはあるがフレンドがきれいになってからでいいや。

じゃあ旧方式の痕跡を消そう。上書きもつくらないといけないけどこのつぎってことで。


---------------------------------------------------------------
フェーズ１に必要な機能

・口座メンテ（はじめはScaffold?にまかせる)
・取引系
　・登録
　・表示
　・削除

フェーズ２の最終調整（か次なのか）

日付について

・月は選んだらそれが記入にも修正にも適用されてほしい
・入力時に月を修正できるようにしたい　入力した段階で表示結果は移動してほしい
・上部にカレンダーがあるのがいい
　・・・だんだん前つかってたやつに似てきてやだなｗ
　でも全部選べるのはやだな。「今月」が右はじのほうにあるのがいい。来月とかはあっていい。　

　たとえば２００６年４月が現在であれば

 --2005  2006-------------
　←　１２　　１　　２　　３　　！４！　５　→ 
        [2006]/[4]

　かな。４ヶ月前から来月までが選べればおおむねよい。

 JavaScriptで自由に選べるようにしたい。入力したらその月が現在の位置になるようにスクロールする。
 日付をカレンダーで入れる必要性はあまり感じないが、同様に
 
 -- 2006/4 ----------------
 土     日     月     火	　水   　木     金
　15  16  17  18  19 !20! 21
   [2006]/[4]/[20]

であってもよいかもしれない。そんなに凝るのは急がないが毎度月を入力するのはいやだなぁ。

日めくり感覚でもいいなぁ。

 --2005  2006-------------  	|			|
　←　１２　　１　　２　　３　　！４！　５　→  	| 20日(木)	|
                [2006]/[4]	  - | [20]		|+


・今日記入したものは色が変わってほしい
　→記入日は残ってほしい


残高について

そうだ、残高やらなくちゃ・・・。

・各口座の残高が簡単に見られるようにしたい
・残高確認入力がしたい
　これはフェーズ２では無理かなぁ？　初期値としてもでも必要だよな。
　設計上問題なのは、取引の一種なのかそうではないのか。
　というかこれをやるためにシーケンスにしたんだから取引の一種にせざるをえません。
　account_entryにbalanceを設けてさ、これにひもづくだけの取引を作る。
　んで、要求された「時点」においての最新のbalance以降（＋時点まで）で残高を計算。

