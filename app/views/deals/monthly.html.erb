<div style="float:right">
  <%= form_tag(search_deals_path, :method => :get) do -%>
    <%= text_field_tag :keyword, "", :size => 14 %>
    <br />
    <%= submit_tag '明細を検索', :class => 'button', :onClick => "if($('keyword').value == '') {alert('キーワードを入力してください。'); return false;}" %>
  <% end -%>
</div>
<%= render(:partial => "shared/calendar", :locals => {:year => @year, :month => @month, :url_method => :monthly_deals_path}) %>
<div style="clear:right;"></div>

<div id="day_navigator_frame">
  <table id="day_navigator">
    <% date = Date.new(@year.to_i, @month.to_i, 1) %>
    <% while (date.month == @month.to_i) %>
      <% deal_exists = @deals.detect{|d| d.date == date}  %>
      <tr>
        <td class="day">
          <div class="cwday<%= date.cwday%><%= date == Date.today ? ' today' : '' %>">
            <%= link_to l(date, :format => :day), "#day#{date.day}", :day => date.day %>
          </div>
        </td>
        <td><%= '*' if deal_exists %></td>
      </tr>
      <% date += 1 %>
    <% end %>
  </table>
  <%= javascript_tag do %>
    <%
      # TODO: 口座別出納などへの適用をみて抽出する
    %>
    jQuery(document).ready(function($){
      $('#day_navigator td.day a').click(function(){
        $('input#date_day').val($(this).attr('day'))
      })
    });

  <% end %>
</div>

<div style="float:left; width: 88%; margin-right: 8px;">

<% deal_type = flash[:"#{controller_name}_deal_type"] %>
<div id="deal_editor">
  <%= deal_editor 1, @year, @month, @day do %>
    <%= render :partial => deal_type == 'balance_deal' ? 'balance_deal_form' : 'general_deal_form' %>
  <% end %>
</div>

<div id="monthly_contents">

  <div id="book" class="bottom_box">
    <%= render :partial => "deals" %>
  </div>
</div>

<%= javascript_tag do %>
  function onGeneralDealSelectedFromGeneral(summary, amount, minus_account_id, plus_account_id) {
    $('deal_debtor_entries_attributes_0_amount').value = amount;
    selectList('deal_creditor_entries_attributes_0_account_id', minus_account_id);
    selectList('deal_debtor_entries_attributes_0_account_id', plus_account_id);
    $('deal_summary').value = summary;
  }
  function selectList(name, value) {
    for (i = 0; i < $(name).options.length; i++) {
      if ($(name).options[i].value == value) {
        $(name).options.selectedIndex = i;
        return;
      }
    }
  }
  function onGeneralDealSelectedFromComplex(summary, amount, minus_account_id, plus_account_id, dealId) {
    if($('notice')){ $('notice').hide();}
    <%= remote_function :update => "deal_forms", :with => "'load=' + dealId", :url => {:action => 'new_complex_deal', :controller => 'deals'}, :method => :get, :complete => 'displaySuggestionsForComplex();' %>;
  }
  function fillForComplexDeal(dealId) {
    if($('notice')){ $('notice').hide();}
    <%= remote_function :update => "deal_forms", :with => "'load=' + dealId", :url => {:action => 'new_complex_deal', :controller => 'deals'}, :method => :get, :complete => 'displaySuggestionsForComplex();' %>;
  }
  function displaySuggestionsForComplex() {
    <%= remote_function :update => 'patterns', :with => "'keyword=' + $('deal_summary').value", :method => :get, :url => deal_suggestions_path(:from => 'complex_deal') %>;
  }
<% end %>

</div>
